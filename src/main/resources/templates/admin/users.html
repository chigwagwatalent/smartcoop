<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Users ‚Ä¢ Chicken System</title>
  <link th:href="@{/css/theme.css}" rel="stylesheet"/>
  <style>
    body{ background:var(--bg); font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink) }
    .page{ width:min(96vw,1600px); margin:0 auto; padding:18px 0 }
    .layout{ display:grid; grid-template-columns: 280px 1fr; gap:18px }
    @media (max-width:1100px){ .layout{ grid-template-columns:1fr } }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:16px; box-shadow:0 16px 36px rgba(2,141,24,.08); padding:16px }
    .header-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--bd); background:#fff; font-weight:800; cursor:pointer; text-decoration:none; color:inherit }
    .btn:hover{ background:#f2faf3 }
    .btn-primary{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; border:0; box-shadow:0 12px 24px rgba(2,141,24,.22) }
    .muted{ color:var(--muted) }
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    thead th{ text-align:left; padding:12px; border-bottom:1px solid var(--bd); color:var(--muted); font-weight:800; position:sticky; top:0; background:#fff; z-index:1 }
    tbody td{ padding:12px; border-bottom:1px solid var(--bd) }
    tbody tr:hover{ background:#f7fbf8 }
    .pagination{ display:flex; gap:10px; align-items:center; justify-content:flex-end; padding-top:10px }
    .page-btn{ border:1px solid var(--bd); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700; text-decoration:none; color:inherit }
    .page-btn[disabled]{ opacity:.4; cursor:not-allowed }
    .page-info{ color:var(--muted); font-weight:700 }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:2000 }
    .modal-backdrop.show{ display:flex }
    .modal{ width:min(92vw,640px); background:#fff; border:1px solid var(--bd); border-radius:16px; box-shadow:0 26px 60px rgba(0,0,0,.18); padding:16px }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
    .modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .field{ margin:10px 0 }
    .field label{ display:block; font-weight:700; margin-bottom:6px }
    .input{ display:flex; align-items:center; border:1.5px solid var(--bd); border-radius:12px; background:#fff; padding: 10px 12px }
    .input input, .input select{ border:0; outline:0; width:100%; font-size:1rem; background:transparent; color:var(--ink) }
    .error{ color:#b91c1c; font-weight:700; font-size:.9rem }
    .badge{ display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--bd); font-weight:700; font-size:.85rem }
    .badge.ok{ background:#ecfdf5; border-color:#a7f3d0 }
    .badge.warn{ background:#fef3c7; border-color:#fde68a }
    @media print{
      .nav-wrap, aside, .header-row, .pagination, footer, .modal-backdrop{ display:none !important }
      body{ background:#fff }
      .page{ width:100%; margin:0; padding:0 }
      .card{ border:1px solid #ddd; box-shadow:none }
      thead th{ position:static }
    }
  </style>
</head>
<body>
  <div th:replace="~{common/navbar :: navbar}"></div>

  <div class="page">
    <div class="layout">
      <div th:replace="~{common/sidebar :: sidebar('users')}"></div>

      <main style="align-self:start">
        <div class="card">
          <div class="header-row">
            <div>
              <h2 style="margin:0">Users</h2>
              <div class="muted tiny">Manage application users</div>
            </div>
            <div style="display:flex; gap:8px">
              <form th:action="@{/users}" method="get" style="display:flex; gap:8px; align-items:center">
                <input type="hidden" name="page" th:value="${pageIndex}"/>
                <select name="size" class="page-btn" style="padding-right:30px" onchange="this.form.submit()">
                  <option th:selected="${size==10}">10</option>
                  <option th:selected="${size==20}">20</option>
                  <option th:selected="${size==50}">50</option>
                </select>
              </form>
              <button type="button" class="btn btn-primary" id="addBtn">‚ûï Add</button>
            </div>
          </div>

          <div style="overflow:auto; max-height:65vh">
            <table>
              <thead>
              <tr>
                <th style="width:160px">Created</th>
                <th>Username</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th style="width:220px">Actions</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="u : ${page.content}">
                <td th:text="${#temporals.format(u.createdAt,'yyyy-MM-dd HH:mm')}">2025-01-01 10:00</td>
                <td th:text="${u.username}">username</td>
                <td th:text="${u.fullName}">Full Name</td>
                <td th:text="${u.email}">user@email</td>
                <td><span class="badge" th:text="${u.role}">USER</span></td>
                <td>
                  <span class="badge ok" th:if="${u.enabled && !u.locked}">Enabled</span>
                  <span class="badge warn" th:if="${!u.enabled}">Disabled</span>
                  <span class="badge warn" th:if="${u.locked}">Locked</span>
                </td>
                <td>
                  <button type="button" class="btn"
                          th:attr="data-id=${u.id},
                                   data-username=${u.username},
                                   data-fullname=${u.fullName},
                                   data-email=${u.email},
                                   data-role=${u.role},
                                   data-enabled=${u.enabled},
                                   data-locked=${u.locked}"
                          onclick="openEdit(this)">‚úé Edit</button>
                  <form th:action="@{/users/delete}" method="post" style="display:inline">
                    <input type="hidden" name="id" th:value="${u.id}"/>
                    <input type="hidden" name="page" th:value="${pageIndex}"/>
                    <input type="hidden" name="size" th:value="${size}"/>
                    <button type="submit" class="btn" style="background:#fee2e2; border-color:#fecaca">üóë Delete</button>
                  </form>
                </td>
              </tr>
              <tr th:if="${page.content.isEmpty()}">
                <td colspan="7" class="muted">No users yet.</td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="pagination">
            <a class="page-btn" th:href="@{/users(page=${pageIndex-1},size=${size})}" th:if="${page.hasPrevious()}">‚Üê Prev</a>
            <span class="page-info">Page <span th:text="${pageIndex+1}">1</span> / <span th:text="${page.totalPages > 0 ? page.totalPages : 1}">1</span></span>
            <a class="page-btn" th:href="@{/users(page=${pageIndex+1},size=${size})}" th:if="${page.hasNext()}">Next ‚Üí</a>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="editModal"
       th:classappend="${openModal} ? ' show' : ''"
       aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h3 id="modalTitle" style="margin:0" th:text="${form.id}==null ? 'Add User' : 'Edit User'">Add User</h3>
        <button type="button" class="btn" onclick="closeModal('#editModal')">‚úñ</button>
      </div>

      <div th:if="${errorMessage}" class="error" th:text="${errorMessage}"></div>

      <form th:action="@{/users/save}" th:object="${form}" method="post">
        <input type="hidden" name="page" th:value="${pageIndex}"/>
        <input type="hidden" name="size" th:value="${size}"/>
        <input type="hidden" th:field="*{id}"/>

        <div class="grid">
          <div class="field">
            <label for="fUsername">Username</label>
            <div class="input"><input id="fUsername" th:field="*{username}" placeholder="jdoe"/></div>
            <div class="error" th:if="${#fields.hasErrors('username')}" th:errors="*{username}">Invalid</div>
          </div>

          <div class="field">
            <label for="fFullName">Full Name</label>
            <div class="input"><input id="fFullName" th:field="*{fullName}" placeholder="John Doe"/></div>
            <div class="error" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}">Invalid</div>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label for="fEmail">Email</label>
            <div class="input"><input id="fEmail" th:field="*{email}" placeholder="user@example.com"/></div>
            <div class="error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">Invalid</div>
          </div>

          <div class="field">
            <label for="fRole">Role</label>
            <div class="input">
              <select id="fRole" th:field="*{role}">
                <option th:each="r : ${roles}" th:value="${r}" th:text="${r}">USER</option>
              </select>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label for="fPassword">Password <span class="muted tiny">(required on create)</span></label>
            <div class="input"><input id="fPassword" type="password" th:field="*{password}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
            <div class="error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}">Invalid</div>
          </div>
          <div class="field">
            <label for="fConfirm">Confirm Password</label>
            <div class="input"><input id="fConfirm" type="password" th:field="*{confirmPassword}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
            <div class="error" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}">Invalid</div>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label>Status</label>
            <div style="display:flex; gap:16px; align-items:center">
              <label style="display:flex; gap:8px; align-items:center">
                <input type="checkbox" th:field="*{enabled}"/>
                <span>Enabled</span>
              </label>
              <label style="display:flex; gap:8px; align-items:center">
                <input type="checkbox" th:field="*{locked}"/>
                <span>Locked</span>
              </label>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeModal('#editModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script th:inline="javascript">
    function openModal(sel){
      const el = document.querySelector(sel);
      if(!el) return;
      el.classList.add('show');
      el.setAttribute('aria-hidden','false');
      const input = el.querySelector('input,button,select,textarea');
      if(input) setTimeout(()=> input.focus(), 0);
      el.addEventListener('click', (e)=>{ if(e.target===el) closeModal(sel); }, {once:true});
    }
    function closeModal(sel){
      const el = document.querySelector(sel);
      if(!el) return;
      el.classList.remove('show');
      el.setAttribute('aria-hidden','true');
    }

    document.getElementById('addBtn')?.addEventListener('click', ()=>{
      // clear the form fields
      document.querySelector('#editModal [name="id"]').value = '';
      document.getElementById('fUsername').value = '';
      document.getElementById('fFullName').value = '';
      document.getElementById('fEmail').value = '';
      document.getElementById('fPassword').value = '';
      document.getElementById('fConfirm').value = '';
      const roleSel = document.getElementById('fRole');
      if (roleSel && roleSel.options.length) roleSel.selectedIndex = 0;
      const enabled = document.querySelector('#editModal [name="enabled"]');
      const locked  = document.querySelector('#editModal [name="locked"]');
      if (enabled) enabled.checked = true;
      if (locked)  locked.checked = false;

      document.getElementById('modalTitle').textContent = 'Add User';
      openModal('#editModal');
    });

    function openEdit(btn){
      document.getElementById('modalTitle').textContent = 'Edit User';
      document.querySelector('#editModal [name="id"]').value = btn.getAttribute('data-id') || '';
      document.getElementById('fUsername').value = btn.getAttribute('data-username') || '';
      document.getElementById('fFullName').value = btn.getAttribute('data-fullname') || '';
      document.getElementById('fEmail').value = btn.getAttribute('data-email') || '';
      document.getElementById('fPassword').value = '';
      document.getElementById('fConfirm').value = '';

      const roleSel = document.getElementById('fRole');
      const r = btn.getAttribute('data-role');
      if (roleSel && r) roleSel.value = r;

      const enabled = document.querySelector('#editModal [name="enabled"]');
      const locked  = document.querySelector('#editModal [name="locked"]');
      if (enabled) enabled.checked = (btn.getAttribute('data-enabled') === 'true');
      if (locked)  locked.checked = (btn.getAttribute('data-locked') === 'true');

      openModal('#editModal');
    }
  </script>
</body>
</html>
