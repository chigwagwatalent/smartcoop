<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Coop Camera • Smart Coop</title>
  <link th:href="@{/css/theme.css}" rel="stylesheet"/>

  <style>
    :root{
      --brand:#028d18; --brand-2:#4cc36a;
      --ink:#0b1f11; --muted:#6b7280;
      --bg:#ffffff; --bg-2:#ffffff;
      --glass: rgba(255,255,255,.7);
      --bd:#e6e9ee; --card:#ffffff;
      --ok:#0ea74a; --warn:#f59e0b; --err:#ef4444;
      --shadow: 0 14px 40px rgba(2,141,24,.08);
      --shadow-2: 0 24px 60px rgba(2,141,24,.10);
    }

    /* Page shell */
    body{
      margin:0; color:var(--ink); background:var(--bg);
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .page{ width:min(96vw,1600px); margin:0 auto; padding:28px 0 }
    .layout{ display:grid; grid-template-columns: 280px 1fr; gap:20px }
    @media (max-width:1100px){ .layout{ grid-template-columns:1fr } }

    /* Header */
    .hero{
      position:relative; overflow:hidden; margin-bottom:18px;
      background: linear-gradient(135deg, rgba(2,141,24,.06), rgba(76,195,106,.04));
      border:1px solid var(--bd); border-radius:18px; padding:18px;
      box-shadow: var(--shadow);
    }
    .hero h2{ margin:0; font-weight:900; letter-spacing:.2px }
    .sub{ color:var(--muted); margin-top:4px }

    /* Card */
    .card{
      background: var(--card);
      border:1px solid var(--bd); border-radius:18px; padding:16px;
      box-shadow: var(--shadow-2);
    }

    /* Viewport */
    .viewport{
      position:relative; border-radius:14px; overflow:hidden;
      background:#000; border:1px solid var(--bd);
      aspect-ratio: 16/9; max-height: 78vh;
      cursor: zoom-in; transition: box-shadow .25s ease, transform .25s ease;
      box-shadow: 0 12px 30px rgba(17,24,39,.08);
    }
    .viewport:hover{ transform: translateY(-1px); box-shadow: 0 18px 40px rgba(17,24,39,.12) }
    .viewport img{ width:100%; height:100%; object-fit:contain; display:block; background:#000; }

    /* Loading shimmer (light) */
    .skeleton{
      position:absolute; inset:0; background:
        linear-gradient(90deg, rgba(255,255,255,0) 0%,
                               rgba(2,141,24,.10) 50%,
                               rgba(255,255,255,0) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.8s infinite;
      opacity:.45; pointer-events:none;
    }
    @keyframes shimmer{ 0%{background-position:-100% 0} 100%{background-position:100% 0} }

    /* Status pill */
    .overlay{ position:absolute; inset:12px 12px auto auto; display:flex; gap:8px; z-index:3 }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:7px 12px;
      border-radius:999px; border:1px solid var(--bd); background:#ffffffdd;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      font-weight:800; letter-spacing:.2px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 6px 16px rgba(0,0,0,.06);
      color:var(--ink);
    }
    .dot{ width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.07) inset }
    .live  .dot{ background:var(--ok) }
    .warn  .dot{ background:var(--warn) }
    .error .dot{ background:var(--err) }

    /* Footer hints */
    .hints{ color:var(--muted); font-size:.92rem; margin-top:12px }
    code{ padding:.15rem .35rem; border-radius:6px; background:#f7fafc; border:1px solid var(--bd) }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div th:replace="~{common/navbar :: navbar}"></div>

  <div class="page">
    <div class="layout">
      <!-- Sidebar -->
      <div th:replace="~{common/sidebar :: sidebar('dashboard')}"></div>

      <!-- Content -->
      <main style="align-self:start">
        <div class="hero">
          <h2>Coop Camera</h2>
          <div class="sub">Live view • Click the video to toggle fullscreen</div>
        </div>

        <div class="card">
          <div class="viewport" id="viewport" title="Click to toggle fullscreen">
            <!-- Status -->
            <div class="overlay">
              <span class="pill warn" id="statusPill"><span class="dot"></span><span id="statusText">Connecting…</span></span>
            </div>

            <!-- Shimmer while loading -->
            <div class="skeleton" id="skeleton"></div>

            <!-- MJPEG image stream -->
            <img id="camImg" alt="Coop camera stream" />
          </div>

          <div class="hints">
            Stream: <code th:text="${cameraUrl} + '/stream'">http://esp32cam.local:567/stream</code> ·
            Health: <code th:text="${cameraUrl} + '/health'">http://esp32cam.local:567/health</code> ·
            Shot: <code th:text="${cameraUrl} + '/snapshot'">http://esp32cam.local:567/snapshot</code>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Footer -->
  <div th:replace="~{common/footer :: footer}"></div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const cameraBase = /*[[${cameraUrl}]]*/ 'http://esp32cam.local:567';
    const streamUrl  = cameraBase + '/stream';
    const healthUrl  = cameraBase + '/health';

    const viewport   = document.getElementById('viewport');
    const imgEl      = document.getElementById('camImg');
    const skeleton   = document.getElementById('skeleton');
    const pill       = document.getElementById('statusPill');
    const statusTxt  = document.getElementById('statusText');

    function setState(kind, text){
      pill.classList.remove('live','warn','error');
      pill.classList.add(kind);
      statusTxt.textContent = text;
    }

    function startImg(){
      imgEl.src = streamUrl + (streamUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
    }

    async function pingHealth(timeoutMs = 2500){
      try{
        const ctl = new AbortController();
        const t = setTimeout(()=>ctl.abort(), timeoutMs);
        const r = await fetch(healthUrl, {signal: ctl.signal, mode:'cors', cache:'no-store'});
        clearTimeout(t);
        return r.ok;
      }catch(_){ return false; }
    }

    // Auto retry with backoff
    let retry = 0;
    async function boot(){
      setState('warn','Checking camera…');
      const ok = await pingHealth();
      if(!ok){
        setState('error','No response — retrying…');
      }else{
        setState('warn','Connecting…');
      }
      skeleton.style.display = 'block';
      startImg();
    }

    imgEl.addEventListener('load', () => {
      skeleton.style.display = 'none';
      setState('live','Live');
      retry = 0;
    });

    imgEl.addEventListener('error', async () => {
      skeleton.style.display = 'block';
      setState('error','Stream lost — reconnecting…');
      retry = Math.min(retry + 1, 6);
      const delay = 600 * retry; // backoff
      setTimeout(()=> startImg(), delay);
    });

    // Gentle keep-alive
    setInterval(() => {
      if (pill.classList.contains('live')){
        imgEl.src = streamUrl + (streamUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
      }
    }, 60000);

    // Click to toggle fullscreen
    viewport.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        viewport.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    });

    document.addEventListener('DOMContentLoaded', boot);
    /*]]>*/
  </script>
</body>
</html>
