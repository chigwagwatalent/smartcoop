<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IoT Readings ‚Ä¢ Chicken System</title>
  <link th:href="@{/css/theme.css}" rel="stylesheet"/>
  <style>
    body{ background:var(--bg); font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink) }
    .page{ width:min(96vw,1600px); margin:0 auto; padding:18px 0 }
    .layout{ display:grid; grid-template-columns: 280px 1fr; gap:18px }
    @media (max-width:1100px){ .layout{ grid-template-columns: 1fr } }
    .grid{ display:grid; gap:14px }
    .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)) }
    @media (max-width:1100px){ .grid-3{ grid-template-columns:1fr } }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:16px; box-shadow:0 16px 36px rgba(2,141,24,.08); padding:16px }
    .kpi{ display:flex; gap:12px; align-items:center }
    .kpi .icon{
      width:48px; height:48px; border-radius:12px; display:grid; place-items:center; color:#fff;
      background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:0 12px 22px rgba(2,141,24,.2); font-size:22px;
    }
    .kpi .label{ color:var(--muted); font-weight:700 }
    .kpi .value{ font-size:1.9rem; font-weight:900 }
    .actions{ display:flex; gap:10px; align-items:center; justify-content:flex-end }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--bd); background:#fff; font-weight:800; cursor:pointer }
    .btn:hover{ background:#f2faf3 }
    .btn-primary{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; border:0; box-shadow:0 12px 24px rgba(2,141,24,.22) }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ text-align:left; padding:12px; border-bottom:1px solid var(--bd); color:var(--muted); font-weight:800; position:sticky; top:0; background:#fff; z-index:1 }
    tbody td{ padding:12px; border-bottom:1px solid var(--bd) }
    tbody tr:hover{ background:#f7fbf8 }
    .pagination{ display:flex; gap:10px; align-items:center; justify-content:flex-end; padding-top:10px }
    .page-btn{ border:1px solid var(--bd); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700 }
    .page-btn[disabled]{ opacity:.4; cursor:not-allowed }
    .page-info{ color:var(--muted); font-weight:700 }
    @media print{
      .nav-wrap, aside, .actions, .pagination, footer{ display:none !important }
      body{ background:#fff }
      .page{ width:100%; margin:0; padding:0 }
      .card{ box-shadow:none; border:1px solid #ddd }
      thead th{ position:static }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div th:replace="~{common/navbar :: navbar}"></div>

  <div class="page">
    <div class="layout">
      <!-- Sidebar -->
      <div th:replace="~{common/sidebar :: sidebar('iot')}"></div>

      <!-- Content -->
      <main class="grid" style="align-self:start">
        <!-- Top current values -->
        <section class="grid grid-3">
          <div class="card">
            <div class="kpi">
              <div class="icon">üå°Ô∏è</div>
              <div>
                <div class="label">Temperature (¬∞C)</div>
                <div class="value" id="kpi-temp" th:text="${summary.temperatureC}">0</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div class="icon">üíß</div>
              <div>
                <div class="label">Humidity (%)</div>
                <div class="value" id="kpi-hum" th:text="${summary.humidityPct}">0</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="kpi">
              <div class="icon">üõ¢Ô∏è</div>
              <div>
                <div class="label">Water Level (%)</div>
                <div class="value" id="kpi-level" th:text="${summary.waterLevelPct}">0</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Actions -->
        <section class="actions">
          <button class="btn" onclick="location.reload()">‚Üª Refresh</button>
          <button class="btn btn-primary" onclick="window.print()">üñ® Print</button>
        </section>

        <!-- Table -->
        <section class="card">
          <h3 style="margin:0 0 12px">Readings</h3>
          <div style="overflow:auto; max-height:65vh">
            <table id="iot-table">
              <thead>
                <tr>
                  <th style="width:120px">Timestamp</th>
                  <th>Temperature (¬∞C)</th>
                  <th>Humidity (%)</th>
                  <th>Water Level (%)</th>
                </tr>
              </thead>
              <tbody id="iot-tbody">
              <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>

          <div class="pagination">
            <button id="prevBtn" class="page-btn">‚Üê Prev</button>
            <span class="page-info" id="pageInfo">Page 1 / 1</span>
            <button id="nextBtn" class="page-btn">Next ‚Üí</button>
            <select id="pageSize" class="page-btn" style="padding-right:30px">
              <option>10</option><option>20</option><option>50</option>
            </select>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Footer -->
  <div th:replace="~{common/footer :: footer}"></div>

  <script>
    // ---------- helpers
    function td(text){ const c=document.createElement('td'); c.textContent=text; return c; }
    function fmt(n){ return (n===null||n===undefined) ? '0' : n; }

    // ---------- paging
    let curPage = 0, totalPages = 1;

    async function loadPage(page = 0){
      const size = parseInt(document.getElementById('pageSize').value, 10) || 10;
      const res = await fetch(`/api/iot/readings?page=${page}&size=${size}`, { headers:{ 'Accept':'application/json' } });
      const data = await res.json();

      // table
      const tbody = document.getElementById('iot-tbody');
      tbody.innerHTML = '';
      (data.content || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.appendChild(td(r.createdAt?.replace('T',' ').slice(0,19) || ''));
        tr.appendChild(td(r.temperatureC));
        tr.appendChild(td(r.humidityPct));
        tr.appendChild(td(r.waterLevelPct));
        tbody.appendChild(tr);
      });

      // pagination
      curPage = data.page;
      totalPages = data.totalPages;
      document.getElementById('pageInfo').textContent = `Page ${curPage+1} / ${Math.max(totalPages,1)}`;
      document.getElementById('prevBtn').disabled = curPage <= 0;
      document.getElementById('nextBtn').disabled = curPage >= totalPages-1;
    }

    document.getElementById('prevBtn').addEventListener('click', ()=> loadPage(curPage-1));
    document.getElementById('nextBtn').addEventListener('click', ()=> loadPage(curPage+1));
    document.getElementById('pageSize').addEventListener('change', ()=> loadPage(0));

    // ---------- current KPIs updater
    function updateKpis(obj){
      if(!obj) return;
      document.getElementById('kpi-temp').textContent  = fmt(obj.temperatureC ?? obj.temperature);
      document.getElementById('kpi-hum').textContent   = fmt(obj.humidityPct ?? obj.humidity);
      document.getElementById('kpi-level').textContent = fmt(obj.waterLevelPct ?? obj.level);
    }

    // ---------- SSE live updates
    function connectSSE(){
      try{
        const es = new EventSource('/api/iot/stream');
        es.addEventListener('reading', (ev)=>{
          const data = JSON.parse(ev.data || '{}');
          updateKpis(data);

          // If we're on page 0, prepend row
          if(curPage === 0){
            const tbody = document.getElementById('iot-tbody');
            const tr = document.createElement('tr');
            tr.appendChild(td((data.createdAt||'').replace('T',' ').slice(0,19)));
            tr.appendChild(td(data.temperatureC));
            tr.appendChild(td(data.humidityPct));
            tr.appendChild(td(data.waterLevelPct));
            if(tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild);
            else tbody.appendChild(tr);
          }
        });
        es.addEventListener('error', ()=>{ es.close(); setTimeout(connectSSE, 3000); }); // auto-retry
      }catch(e){
        console.warn('SSE not available, fallback to polling');
        setInterval(()=> loadPage(curPage), 10000);
      }
    }

    // ---------- boot
    (async function init(){
      await loadPage(0);
      connectSSE();
    })();
  </script>
</body>
</html>
